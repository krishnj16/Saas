const pool = require('../utils/db'); 
const { DateTime } = require('luxon');

async function enqueueVTJob({ sha256, scan_task_id = null, related_vuln_id = null, file_path = null }) {
  const res = await pool.query(
    `INSERT INTO virustotal_queue (sha256, scan_task_id, related_vuln_id, file_path)
     VALUES ($1,$2,$3,$4) RETURNING *`,
    [sha256, scan_task_id, related_vuln_id, file_path]
  );
  return res.rows[0];
}

async function getCachedResult(sha256) {
  const res = await pool.query(
    `SELECT * FROM malware_results
     WHERE sha256 = $1 AND expires_at > now()
     LIMIT 1`,
    [sha256]
  );
  return res.rows[0] || null;
}

async function upsertMalwareResult({ sha256, vt_response, positives = null, vt_last_seen = null, ttlDays = 7 }) {
  const expiresAt = DateTime.now().plus({ days: ttlDays }).toISO();
  const res = await pool.query(
    `
    INSERT INTO malware_results (sha256, vt_response, positives, vt_last_seen, scanned_at, expires_at)
    VALUES ($1, $2, $3, $4, now(), $5)
    ON CONFLICT (sha256) DO UPDATE
      SET vt_response = EXCLUDED.vt_response,
          positives = EXCLUDED.positives,
          vt_last_seen = EXCLUDED.vt_last_seen,
          scanned_at = now(),
          expires_at = EXCLUDED.expires_at
    RETURNING *`,
    [sha256, vt_response, positives, vt_last_seen, expiresAt]
  );
  return res.rows[0];
}

async function fetchNextQueueJob() {
  const res = await pool.query(
    `SELECT * FROM virustotal_queue ORDER BY created_at ASC LIMIT 1`
  );
  return res.rows[0] || null;
}

async function markQueueJobAttempt(id) {
  await pool.query(
    `UPDATE virustotal_queue SET attempts = attempts + 1, last_attempt_at = now() WHERE id = $1`,
    [id]
  );
}

async function removeQueueJob(id) {
  await pool.query(`DELETE FROM virustotal_queue WHERE id = $1`, [id]);
}

module.exports = {
  enqueueVTJob,
  getCachedResult,
  upsertMalwareResult,
  fetchNextQueueJob,
  markQueueJobAttempt,
  removeQueueJob
};
