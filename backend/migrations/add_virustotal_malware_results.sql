
BEGIN;

CREATE TABLE IF NOT EXISTS virustotal_queue (
  id SERIAL PRIMARY KEY,
  sha256 TEXT NOT NULL,
  scan_task_id UUID NULL,
  related_vuln_id UUID NULL,
  file_path TEXT NULL,
  attempts INT DEFAULT 0,
  last_attempt_at TIMESTAMP WITH TIME ZONE NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE TABLE IF NOT EXISTS malware_results (
  id SERIAL PRIMARY KEY,
  sha256 TEXT UNIQUE NOT NULL,
  vt_response JSONB NULL,
  positives INT NULL,
  vt_last_seen TIMESTAMP WITH TIME ZONE NULL,
  scanned_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  expires_at TIMESTAMP WITH TIME ZONE NULL
);

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name='vulnerabilities' AND column_name='malware_result_id'
  ) THEN
    ALTER TABLE vulnerabilities ADD COLUMN malware_result_id INT NULL;
  END IF;
END$$;

CREATE INDEX IF NOT EXISTS idx_virustotal_queue_sha256 ON virustotal_queue(sha256);
CREATE INDEX IF NOT EXISTS idx_malware_results_sha256 ON malware_results(sha256);

COMMIT;
