CREATE TABLE IF NOT EXISTS virustotal_queue (
  id SERIAL PRIMARY KEY,
  sha256 TEXT NOT NULL,
  scan_task_id UUID,            
  related_vuln_id UUID,        
  file_path TEXT,               
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  attempts INT DEFAULT 0,
  last_attempt_at TIMESTAMP WITH TIME ZONE
);


CREATE TABLE IF NOT EXISTS malware_results (
  id SERIAL PRIMARY KEY,
  sha256 TEXT UNIQUE NOT NULL,
  vt_response JSONB,            
  positives INT,                
  vt_last_seen TIMESTAMP WITH TIME ZONE, 
  scanned_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  expires_at TIMESTAMP WITH TIME ZONE 
);


ALTER TABLE IF EXISTS vulnerabilities
ADD COLUMN IF NOT EXISTS malware_result_id INT REFERENCES malware_results(id);
CREATE INDEX IF NOT EXISTS idx_malware_results_sha256 ON malware_results(sha256);
CREATE INDEX IF NOT EXISTS idx_virustotal_queue_sha256 ON virustotal_queue(sha256);
