CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE IF NOT EXISTS vulnerability_findings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  website_id UUID NOT NULL,
  scan_id UUID NOT NULL,
  path TEXT NOT NULL,
  parameter TEXT,
  type TEXT,
  scanner TEXT NOT NULL,
  scanner_severity TEXT,
  scanner_fingerprint TEXT NOT NULL,
  normalized_severity TEXT NOT NULL,
  vt_malicious BOOLEAN DEFAULT FALSE,
  vt_score INTEGER,
  exploitability_score INTEGER DEFAULT 0,
  rule_tags TEXT[] DEFAULT ARRAY[]::text[],
  first_seen_at TIMESTAMPTZ DEFAULT now(),
  last_seen_at TIMESTAMPTZ DEFAULT now(),
  removed_at TIMESTAMPTZ,
  status TEXT DEFAULT 'unchanged',
  new_since_last_scan BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE UNIQUE INDEX IF NOT EXISTS uq_vuln_dedupe
ON vulnerability_findings (website_id, path, parameter, type, scanner_fingerprint);

CREATE TABLE IF NOT EXISTS scanner_severity_map (
  scanner TEXT NOT NULL,
  scanner_severity TEXT NOT NULL,
  normalized_severity TEXT NOT NULL,
  PRIMARY KEY (scanner, scanner_severity)
);

CREATE INDEX IF NOT EXISTS idx_vuln_website ON vulnerability_findings (website_id);
CREATE INDEX IF NOT EXISTS idx_vuln_scan ON vulnerability_findings (scan_id);
CREATE INDEX IF NOT EXISTS idx_vuln_lastseen ON vulnerability_findings (website_id, last_seen_at);
