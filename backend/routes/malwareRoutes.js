const logger = require('../services/logger');
const express = require('express');
const router = express.Router();
const { downloadAndHash, cleanupFile } = require('../services/fileDownloader');
const { enqueueVTJob } = require('../services/malwareService');

router.post('/download-and-queue', async (req, res) => {
  const { url, scan_task_id = null, related_vuln_id = null } = req.body || {};
  if (!url) return res.status(400).json({ error: 'url required' });

  try {
    const { sha256, tmpFilePath, tmpDir, totalBytes, contentType } = await downloadAndHash(url);
    await enqueueVTJob({ sha256, scan_task_id, related_vuln_id, file_path: tmpFilePath });

    await cleanupFile(tmpFilePath, tmpDir);

    return res.json({ sha256, totalBytes, contentType, queued: true });
  } catch (e) {
    logger.error('download-and-queue error', e);
    let code = e.code || 'DOWNLOAD_ERROR';
    return res.status(400).json({ error: e.message || 'download failed', code });
  }
});

module.exports = router;
