jest.mock('../../utils/db', () => {
  const rows = [];
  return {
    query: jest.fn(async (sql, params) => {
      if (/INSERT INTO virustotal_queue/i.test(sql)) {
        const id = rows.length + 1;
        const newRow = { id, sha256: params[0], scan_task_id: params[1], related_vuln_id: params[2], file_path: params[3], created_at: new Date() };
        rows.push(newRow);
        return { rows: [newRow] };
      }
      if (/SELECT \* FROM malware_results/i.test(sql)) {
        const found = rows.find(r => r.sha256 === params[0]);
        return { rows: found ? [found] : [] };
      }
      if (/INSERT INTO malware_results/i.test(sql)) {
        const id = rows.length + 1;
        const newRow = { id, sha256: params[0], vt_response: params[1], positives: params[2], vt_last_seen: params[3] };
        rows.push(newRow);
        return { rows: [newRow] };
      }
      if (/DELETE FROM virustotal_queue/i.test(sql)) {
        return { rows: [] };
      }
      return { rows: [] };
    })
  };
});

const {
  enqueueVTJob,
  getCachedResult,
  upsertMalwareResult,
  fetchNextQueueJob,
  markQueueJobAttempt,
  removeQueueJob
} = require('../../services/malwareService');

describe('malwareService (DB interactions mocked)', () => {
  test('enqueueVTJob inserts a queue row', async () => {
    const res = await enqueueVTJob({ sha256: 'abc123', scan_task_id: null, related_vuln_id: null, file_path: '/tmp/x' });
    expect(res).toHaveProperty('sha256', 'abc123');
  });

  test('upsertMalwareResult inserts and returns row', async () => {
    const res = await upsertMalwareResult({ sha256: 'abc123', vt_response: { foo: 1 }, positives: 2, vt_last_seen: new Date().toISOString(), ttlDays: 1 });
    expect(res).toHaveProperty('sha256', 'abc123');
  });

  test('getCachedResult returns null when none', async () => {
    const r = await getCachedResult('doesnotexist');
    expect(r).toBeNull();
  });
});
