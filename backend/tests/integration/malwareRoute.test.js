

const request = require('supertest');
const express = require('express');
const nock = require('nock');
const fs = require('fs');
const path = require('path');

jest.mock('../../services/malwareService', () => ({
  enqueueVTJob: jest.fn(async (args) => {
    return { id: 1, ...args };
  }),
  getCachedResult: jest.fn(async (sha256) => null),
  upsertMalwareResult: jest.fn(),
  fetchNextQueueJob: jest.fn(),
  markQueueJobAttempt: jest.fn(),
  removeQueueJob: jest.fn()
}));

const malwareRoutes = require('../../routes/malwareRoutes');

const app = express();
app.use(express.json());
app.use('/api/malware', malwareRoutes);

const sampleZipPath = path.join(__dirname, '..', 'unit', 'fixtures', 'sample.zip');

describe('POST /api/malware/download-and-queue', () => {
  beforeAll(() => {
    if (!fs.existsSync(sampleZipPath)) {
      fs.mkdirSync(path.dirname(sampleZipPath), { recursive: true });
      fs.writeFileSync(sampleZipPath, Buffer.from([0x50, 0x4B, 0x03, 0x04]));
    }
  });

  afterAll(() => {
    try {
      nock.cleanAll();
      nock.enableNetConnect();
    } catch (e) {}
  });

  test('returns sha256 and queued true on success (mocks downloader + enqueue)', async () => {
    nock('https://plugins.example.com')
      .get('/plugin.zip')
      .replyWithFile(200, sampleZipPath, { 'Content-Type': 'application/zip' });

    const res = await request(app)
      .post('/api/malware/download-and-queue')
      .send({ url: 'https://plugins.example.com/plugin.zip' })
      .expect(200);

    expect(res.body).toHaveProperty('sha256');
    expect(res.body).toHaveProperty('queued', true);
  });

  test('400 if url missing', async () => {
    await request(app)
      .post('/api/malware/download-and-queue')
      .send({})
      .expect(400);
  });
});
